from strands import Agent
from .memory_mock import memory
import os
import logging

logger = logging.getLogger(__name__)

def create_knowledge_base():
    """创建基金知识库"""
    # 创建Agent并添加memory工具
    agent = Agent(tools=[memory])
    
    # 创建知识库数据目录
    knowledge_dir = os.path.join(os.path.dirname(__file__), "data")
    os.makedirs(knowledge_dir, exist_ok=True)
    
    # 创建一些基础知识文档
    create_basic_knowledge_files(knowledge_dir)
    
    # 添加知识文档
    if os.path.exists(knowledge_dir):
        for filename in os.listdir(knowledge_dir):
            if filename.endswith(".txt") or filename.endswith(".md"):
                file_path = os.path.join(knowledge_dir, filename)
                logger.info(f"Adding document to knowledge base: {file_path}")
                with open(file_path, 'r', encoding='utf-8') as f:
                    content = f.read()
                    agent.tool.memory(action="store", content=content)
    
    return agent

def create_basic_knowledge_files(knowledge_dir):
    """创建基础知识文件"""
    # 基金类型知识
    fund_types_content = """# 基金类型及特点

## 股票型基金
股票型基金主要投资于股票市场，通常股票投资比例不低于基金资产的80%。
- **风险等级**：高
- **适合人群**：风险承受能力较强，追求较高回报的投资者
- **投资期限**：长期（3年以上）
- **特点**：收益潜力大，但波动性也较大

## 债券型基金
债券型基金主要投资于债券市场，通常债券投资比例不低于基金资产的80%。
- **风险等级**：中低
- **适合人群**：风险承受能力较低，追求稳定收益的投资者
- **投资期限**：中短期（1-3年）
- **特点**：收益相对稳定，波动性较小

## 混合型基金
混合型基金同时投资于股票和债券市场，股票投资比例一般在30%-80%之间。
- **风险等级**：中高
- **适合人群**：风险承受能力中等，追求平衡收益的投资者
- **投资期限**：中长期（2-5年）
- **特点**：风险和收益介于股票型和债券型基金之间

## 货币市场基金
货币市场基金主要投资于短期货币市场工具，如国债、央行票据、银行存款等。
- **风险等级**：低
- **适合人群**：风险承受能力低，追求流动性和安全性的投资者
- **投资期限**：短期（3个月-1年）
- **特点**：收益较为稳定，流动性高，风险低

## 指数型基金
指数型基金追踪特定指数，如沪深300指数、标普500指数等。
- **风险等级**：中高（取决于跟踪的指数）
- **适合人群**：追求市场平均收益，长期投资的投资者
- **投资期限**：中长期（2-5年）
- **特点**：费用低，透明度高，易于理解

## QDII基金
QDII（合格境内机构投资者）基金投资于海外市场的证券。
- **风险等级**：高
- **适合人群**：希望分散投资到海外市场的投资者
- **投资期限**：长期（3年以上）
- **特点**：可以投资海外市场，分散风险，但同时面临汇率风险

## FOF基金
FOF（基金中的基金）投资于其他基金，而不是直接投资于股票或债券。
- **风险等级**：中（取决于投资的基金类型）
- **适合人群**：希望通过专业管理分散投资的投资者
- **投资期限**：中长期（2-5年）
- **特点**：分散投资，专业管理，但费用可能较高
"""
    
    # 基金风险评估知识
    risk_assessment_content = """# 基金风险评估指标

## 波动率（标准差）
波动率衡量基金收益率的波动程度，是最常用的风险衡量指标。
- **计算方法**：基金收益率的标准差
- **含义**：数值越大，表示基金收益波动越大，风险越高
- **参考值**：
  - 低风险基金：<5%
  - 中风险基金：5%-15%
  - 高风险基金：>15%

## 最大回撤
最大回撤衡量基金从峰值到谷值的最大跌幅。
- **计算方法**：(谷值 - 峰值) / 峰值
- **含义**：数值越大（负值越大），表示基金可能的最大损失越大
- **参考值**：
  - 低风险基金：>-10%
  - 中风险基金：-10% 至 -30%
  - 高风险基金：<-30%

## 夏普比率
夏普比率衡量基金每承担一单位风险所获得的超额收益。
- **计算方法**：(基金收益率 - 无风险收益率) / 基金收益率标准差
- **含义**：数值越大，表示基金的风险调整收益越好
- **参考值**：
  - 优秀：>1
  - 良好：0.5-1
  - 一般：0-0.5
  - 较差：<0

## 贝塔系数
贝塔系数衡量基金相对于市场的波动性。
- **计算方法**：基金收益率与市场收益率的协方差 / 市场收益率的方差
- **含义**：
  - β>1：基金波动性大于市场
  - β=1：基金波动性与市场相同
  - β<1：基金波动性小于市场
- **参考值**：
  - 进攻型基金：>1.2
  - 平衡型基金：0.8-1.2
  - 防御型基金：<0.8

## 信息比率
信息比率衡量基金相对于基准的超额收益与跟踪误差的比值。
- **计算方法**：(基金收益率 - 基准收益率) / 跟踪误差
- **含义**：数值越大，表示基金经理的主动管理能力越强
- **参考值**：
  - 优秀：>1
  - 良好：0.5-1
  - 一般：0-0.5
  - 较差：<0

## VaR（风险价值）
VaR表示在给定的置信水平下，基金在特定时期内可能的最大损失。
- **计算方法**：基于历史数据或统计模型
- **含义**：例如，95%置信水平下的日VaR为2%，表示有95%的概率，基金一天的损失不会超过2%
- **参考值**：取决于基金类型和风险偏好
"""
    
    # 基金费用结构知识
    fee_structure_content = """# 基金费用结构详解

## 申购费
申购费是投资者购买基金时支付的费用，通常按照申购金额的一定比例收取。
- **收费方式**：前端收费（购买时收取）或后端收费（赎回时收取）
- **费率范围**：
  - 股票型/混合型：0.8%-1.5%
  - 债券型：0.3%-0.8%
  - 货币市场型：0%
- **费率优惠**：
  - 大额申购通常有费率优惠
  - 网上交易通常有费率优惠
  - 定期定额投资通常有费率优惠

## 赎回费
赎回费是投资者赎回基金时支付的费用，通常按照持有时间的长短设置不同费率。
- **收费方式**：按照赎回金额的一定比例收取
- **费率范围**：
  - 股票型/混合型：0%-1.5%
  - 债券型：0%-0.5%
  - 货币市场型：0%
- **持有时间与费率**：
  - 持有时间越长，赎回费率越低
  - 通常持有1-2年后，赎回费率降至0%

## 管理费
管理费是基金管理人的报酬，按照基金资产净值的一定比例按日计提。
- **收费方式**：年化费率，按日计提
- **费率范围**：
  - 股票型：1.0%-1.8%
  - 混合型：0.8%-1.5%
  - 债券型：0.4%-0.8%
  - 货币市场型：0.1%-0.3%
  - 指数型：0.5%-1.0%

## 托管费
托管费是基金托管人的报酬，按照基金资产净值的一定比例按日计提。
- **收费方式**：年化费率，按日计提
- **费率范围**：
  - 股票型：0.2%-0.3%
  - 混合型：0.15%-0.25%
  - 债券型：0.1%-0.2%
  - 货币市场型：0.05%-0.1%
  - 指数型：0.1%-0.2%

## 销售服务费
销售服务费主要用于支付销售机构的销售服务费用，按照基金资产净值的一定比例按日计提。
- **收费方式**：年化费率，按日计提
- **费率范围**：
  - C类基金份额：0.2%-0.6%
  - 货币市场型：0.01%-0.25%

## 总费用率（TER）
总费用率是基金所有费用占基金资产净值的比例，是衡量基金成本的重要指标。
- **计算方法**：(管理费 + 托管费 + 销售服务费 + 其他费用) / 基金资产净值
- **参考值**：
  - 股票型：1.5%-2.5%
  - 混合型：1.2%-2.0%
  - 债券型：0.6%-1.2%
  - 货币市场型：0.2%-0.5%
  - 指数型：0.5%-1.5%

## 费用对投资收益的影响
费用是影响基金长期收益的重要因素，尤其是对于长期持有的投资者。
- **示例**：假设两只基金年化收益率均为10%，但总费用率分别为1%和2%，那么20年后，1000元初始投资的最终价值分别为6727元和5743元，相差约17%。
- **选择建议**：
  - 长期投资者应更加关注费用率
  - 主动管理型基金应关注费用是否与业绩匹配
  - 被动投资应优先选择低费用的指数基金
"""
    
    # 基金投资策略知识
    investment_strategy_content = """# 基金投资策略

## 定期定额投资
定期定额投资是指在固定的时间以固定的金额投资基金的策略。
- **优点**：
  - 平均成本效应，降低投资成本
  - 避免择时风险，减少情绪化决策
  - 培养良好的投资习惯
- **适合人群**：
  - 工薪阶层，有稳定收入来源
  - 长期投资者
  - 风险承受能力中等的投资者
- **实施建议**：
  - 选择具有长期增长潜力的基金
  - 坚持至少3-5年以上
  - 投资金额控制在月收入的10%-30%

## 资产配置策略
资产配置是指将投资资金分散到不同类型的资产中，以降低整体风险。
- **常见配置比例**：
  - 激进型：股票型基金70%-90%，债券型基金10%-30%
  - 平衡型：股票型基金40%-60%，债券型基金40%-60%
  - 保守型：股票型基金10%-30%，债券型基金50%-70%，货币市场基金10%-20%
- **调整原则**：
  - 定期再平衡，保持目标配置比例
  - 根据年龄调整，年龄增长，风险资产比例降低
  - 根据市场环境适度调整，但避免频繁交易

## 核心卫星策略
核心卫星策略是将投资组合分为核心部分和卫星部分，核心部分追求稳定，卫星部分追求超额收益。
- **核心部分**：
  - 占比：60%-80%
  - 投资工具：指数基金、ETF、大型宽基基金
  - 目标：获取市场平均收益
- **卫星部分**：
  - 占比：20%-40%
  - 投资工具：主动管理型基金、行业主题基金
  - 目标：获取超额收益

## 价值平均策略
价值平均策略是根据投资组合的目标价值定期调整投资金额的策略。
- **实施步骤**：
  - 设定投资组合的目标增长率
  - 定期计算目标价值
  - 根据实际价值与目标价值的差额进行投资或赎回
- **优点**：
  - 在市场下跌时增加投资，上涨时减少投资
  - 长期来看可能获得更高收益
- **缺点**：
  - 操作较为复杂
  - 在持续下跌市场中需要投入更多资金

## 投资组合再平衡
投资组合再平衡是指定期调整投资组合中各类资产的比例，使其回到目标配置比例。
- **再平衡方式**：
  - 定期再平衡：如每季度、每半年或每年
  - 阈值再平衡：当资产配置比例偏离目标一定程度时
- **优点**：
  - 控制风险，维持目标风险水平
  - 强制执行"高抛低吸"
- **缺点**：
  - 可能产生交易成本和税费
  - 在单边市场中可能降低收益

## 基金定投止盈策略
基金定投止盈策略是在定投过程中设置止盈点，达到一定收益后进行部分赎回或暂停定投。
- **止盈设置**：
  - 绝对收益止盈：如收益率达到30%、50%等
  - 相对收益止盈：如超过基准指数一定比例
- **止盈后操作**：
  - 部分赎回，锁定部分收益
  - 暂停定投，等待回调后再恢复
  - 转投其他基金，分散风险
"""
    
    # 写入文件
    with open(os.path.join(knowledge_dir, "fund_types.md"), "w", encoding="utf-8") as f:
        f.write(fund_types_content)
    
    with open(os.path.join(knowledge_dir, "risk_assessment.md"), "w", encoding="utf-8") as f:
        f.write(risk_assessment_content)
    
    with open(os.path.join(knowledge_dir, "fee_structure.md"), "w", encoding="utf-8") as f:
        f.write(fee_structure_content)
    
    with open(os.path.join(knowledge_dir, "investment_strategy.md"), "w", encoding="utf-8") as f:
        f.write(investment_strategy_content)
    
    logger.info("Created basic knowledge files in directory: " + knowledge_dir)
